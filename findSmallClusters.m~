% filter for small clusters (2-4 neighbrs) using distance to 10 nearest
% neighbrs written to red hdf5 files

close all
clear

%% set parameters
strains = {'npr1','N2'};
wormnums = {'40','HD'};
minIntensities_r = [40, 80]; % script takes 40 for all movies but recordings 54 and 55, which takes 80 because the dynamic ranges were different for those movies
maxBlobSize_r = 250000;
minSkelLength_r = 850;
pixelsize = 100/19.5; % 100 microns is 19.5 pixels
maxNeighbourDist = 1500;
inClusterRadius = 500;
minNumNeighbrs = [2,3,4];
figure;

%% go through different strains, densities, and movies
for numCtr = 1:length(wormnums)
    wormnum = wormnums{numCtr};
    for strainCtr = 1:length(strains)
        strain = strains{strainCtr};
        % load files
        filenames_r = importdata([strains{strainCtr} '_' wormnum '_r_list.txt']);
        numFiles = length(filenames_r);
        for fileCtr = 1:numFiles
            filename_r = filenames_r{fileCtr};
            trajData_r = h5read(filename_r,'/trajectories_data');
            blobFeats_r = h5read(filename_r,'/blob_features');
            skelData_r = h5read(filename_r,'/skeleton');
            numCloseNeighbr_r = h5read(filename_r,'/num_close_neighbrs');
            neighbrDist_r = h5read(filename_r,'/neighbr_distances');
            % filter worms
            if isempty(find(filename_r == 54)) || isempty(find(filename_r == 55)) == (3>2)
                minIntensity = minIntensities_r(1);
            else
                minIntensity = minIntensities_r(2);
            end
            skelLengths = sum(sqrt(sum((diff(skelData_r,1,2)*pixelsize).^2)));
            trajData_r.filtered = (blobFeats_r.intensity_mean >= minIntensity)&...
                (blobFeats_r.area*pixelsize^2 <= maxBlobSize_r)&...
                logical(trajData_r.is_good_skel)&...
                logical(skelLengths(:)>minSkelLength_r);
            % filter for small clusters
            numNeighbrs = length(minNumNeighbrs);
            D = zeros(length(trajData_r.filtered),numNeighbrs);
            for neighbrCtr = 1:length(minNumNeighbrs);
                neighbrNum = minNumNeighbrs(neighbrCtr);
                D(:,neighbrCtr) = trajData_r.filtered&...
                    numCloseNeighbr_r== neighbrNum&...
                    neighbrDist_r(neighbrNum+1)>=maxNeighbourDist;
            end
            % write logical indices for 2-4 neighbors into variable E
            E(numCtr,strainCtr,fileCtr,1)=nnz(D(:,1));
            E(numCtr,strainCtr,fileCtr,2)=nnz(D(:,2));
            E(numCtr,strainCtr,fileCtr,3)=nnz(D(:,3));
        end
    end
end
subplot(2,2,(numCtr-1)*strainCtr+strainCtr)
bar(squeeze(E(numCtr,strainCtr,:,1)))
title(wormnums{numCtr} ' ' strains{s],'FontWeight','normal')